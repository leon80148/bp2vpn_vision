# 血壓紀錄批次檔生成器_for展望系統 v2.0 Ultra - 專案說明

## Agent 團隊開發框架

### 新功能開發
當接收到開發或編寫新功能相關的指令後，請依照 `.claude/Development_Team_Framework.md` 裡面的規範透過 agent 團隊來完成任務。

### Bug 修復和問題解決
當接收到修改或解決 bug 問題相關的指令後，請依照 `.claude/Fix_Team_Framework.md` 裡面的規範透過 agent 團隊來完成任務。

## 專案概述
血壓紀錄批次檔生成器_for展望系統 v2.0 Ultra 是一個專業的醫療資料處理系統，專門用於將展望系統的 DBF 格式病患血壓資料轉換為符合健保署規範的 XML 格式。系統提供現代化的圖形使用者介面，支援大量資料的快速處理和智慧化匯出功能。

## 版本資訊
- **目前版本**: v2.0 Ultra
- **發布日期**: 2024年
- **主要改進**: GUI介面、效能優化、ZIP壓縮匯出、智慧選取功能

## 主要功能

### 核心功能
- 🔍 **智慧資料載入**: 從 VISHFAM.DBF 載入病患名單，自動搜尋 CO18H.DBF 血壓記錄
- 📊 **即時資料顯示**: 現代化表格介面顯示病患資訊和血壓數據
- ✅ **智慧自動選取**: 自動勾選有血壓資料的病患，手動輸入血壓值時自動勾選
- 📝 **即時編輯功能**: 可在介面中直接修改血壓數值
- 📁 **多格式匯出**: 支援純XML或ZIP壓縮檔案匯出
- ⚡ **高效能處理**: 優化演算法可處理 30 萬筆以上資料

### 進階功能
- 🏥 **醫事機構代碼管理**: 必填的10碼醫事機構代碼輸入驗證
- 📅 **彈性日期範圍**: 可選擇今年、三個月內、半年內、一年內的資料範圍
- 🔄 **重複資料處理**: 自動去除重複病患記錄，顯示最新血壓數據
- 💾 **資料完整性**: 自動載入 CO01M.DBF 的出生日期資料補強匯出內容
- 🗜️ **智慧壓縮**: ZIP檔案包含XML及說明文件，減少傳輸負擔

## 技術架構

### 系統環境
- **程式語言**: Python 3.8+
- **GUI 框架**: PySide6 (Qt for Python)
- **資料庫處理**: dbf library
- **作業系統**: Windows 10/11 (主要支援)
- **記憶體需求**: 建議 4GB RAM 以上

### 核心模組
- **UltraBloodPressureLoader**: 超效能血壓資料載入器
- **UltraPatientTableWidget**: 智慧病患資料表格元件  
- **UltraMainWindow**: 主要應用程式視窗

## 資料來源

### DBF 檔案結構
1. **VISHFAM.DBF** - 病患名單主檔
   - 系統主要資料來源，包含應處理的病患清單
   - PAT_PID: 病患病歷號
   - PAT_NAME: 病患姓名
   - PAT_ID: 身分證字號

2. **CO18H.DBF** - 檢驗歷史結果檔
   - 包含血壓等生理數據測量記錄
   - HITEM='BP': 血壓測量項目
   - HVAL: 血壓數值 (格式: "130/80")
   - HDATE: 測量日期 (民國年格式)
   - HTIME: 測量時間

3. **CO01M.DBF** - 病患基本資料表 (選用)
   - KCSTMR: 病患病歷號
   - MBIRTHDT: 出生日期
   - 用於補強匯出資料的完整性

### 資料處理流程
1. **載入階段**: 從 VISHFAM.DBF 讀取目標病患清單
2. **搜尋階段**: 在 CO18H.DBF 中搜尋對應血壓記錄
3. **配對階段**: 解析血壓值 (130/80 → 收縮壓130、舒張壓80)
4. **去重階段**: 每位病患只保留最新的血壓記錄
5. **補強階段**: 從 CO01M.DBF 補充出生日期等資料

## XML 輸出格式
- 遵循健保署「特約醫事服務機構每日上傳檢驗(查)結果」規範
- 使用 `<hdata>` 和 `<rdata>` 結構
- 每位病患包含完整的 h1~h26 標籤
- 收縮壓和舒張壓分別以獨立的 `<rdata>` 區塊記錄
- 輸出編碼: Big5 (符合健保署要求)

## 使用流程

### GUI 操作流程
1. **啟動程式**: 執行 `bp2vpn_gui_ultra.py`
2. **輸入機構代碼**: 填入10碼醫事機構代碼
3. **選擇資料範圍**: 今年/三個月內/半年內/一年內
4. **選擇資料夾**: 指向包含 DBF 檔案的資料夾
5. **自動載入**: 系統載入病患清單和血壓資料
6. **檢視編輯**: 檢查自動勾選的病患，可手動修改血壓值
7. **選擇格式**: 匯出時選擇 XML 或 ZIP 格式
8. **完成匯出**: 產生符合健保署規範的檔案

### 建置部署流程  
1. **開發環境建置**: 執行 `build_executable.bat`
2. **建立分發包**: 執行 `create_installer.bat` 
3. **檔案分發**: 將 release/ 資料夾提供給使用者

## 安全與隱私

### 資料保護措施
- 所有敏感 DBF 檔案已加入 .gitignore，不會上傳至版本控制
- 建置產物 (dist/, build/, release/) 不包含在版本控制中
- 輸出的 XML/ZIP 檔案需妥善保管，含病患個資

### 法規遵循
- 符合醫療隱私相關法規要求
- 病患資料僅用於健保署規範檔案產生
- 建議定期清理暫存和輸出檔案

## 開發技術細節

### 效能優化策略
- 三階段篩選: 日期 → 項目類型 → 病患ID
- 使用 set() 進行 O(1) 查找操作
- 批次處理降低記憶體使用
- 背景執行緒防止 UI 凍結

### 程式碼架構
- **模組化設計**: 載入器、表格元件、主視窗分離
- **事件驅動**: Qt 信號槽機制處理使用者互動
- **錯誤處理**: 完整的例外處理和使用者回饋
- **資料驗證**: 多層驗證確保輸出品質

### 建置系統
- **自動化建置**: build_executable.bat 一鍵建置
- **分發包製作**: create_installer.bat 建立完整安裝包
- **版本管理**: version_info.txt 包含版本資訊
- **文檔完整**: BUILD_GUIDE.md 提供詳細說明

## 系統限制與注意事項
- 主要針對 Windows 環境優化
- 需要充足記憶體處理大量資料 (建議4GB+)
- DBF 檔案格式需符合預期結構
- 病歷號自動格式化為 7 位數（不足左補零）
- 日期格式使用民國年 (Western年-1911)

## 未來發展方向
- 跨平台支援 (macOS, Linux)
- 更多檢驗項目類型支援
- 雲端同步和備份功能
- 進階資料分析和統計報表
- 更精細的權限管理系統