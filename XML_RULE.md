# 血壓紀錄批次檔生成器_for展望系統 XML 匯出規範說明

## 概述
本文件詳細說明血壓紀錄批次檔生成器_for展望系統匯出血壓資料時所遵循的 XML 格式規範，符合健保署「特約醫事服務機構每日上傳檢驗(查)結果」標準。

## XML 結構總覽

```xml
<?xml version="1.0" encoding="Big5"?>
<patient>
  <hdata>
    <!-- 基本資料段 h1-h26 -->
    <h1>1</h1>
    <h2>醫事機構代碼</h2>
    ...
    <!-- 檢驗報告段 rdata -->
    <rdata>
      <!-- 收縮壓資料 -->
    </rdata>
    <rdata>
      <!-- 舒張壓資料 -->
    </rdata>
  </hdata>
</patient>
```

## 基本資料段標籤 (hdata)

### h1 - 報告類別
- **固定值**: `1`
- **說明**: 檢體檢驗報告類別

### h2 - 醫事機構代碼
- **資料來源**: GUI 輸入欄位 `hospital_code_input`
- **格式**: 10 位數字
- **必填**: 是
- **說明**: 使用者在 GUI 中輸入的醫事機構代碼

### h3 - 醫事類別
- **固定值**: `11`
- **說明**: 醫事服務類別

### h4 - 費用年月
- **資料來源**: `patient['hdate']` 前 5 碼 (YYYMM)
- **格式**: 民國年 YYY + 月 MM
- **後備**: 使用當前日期的民國年月
- **範例**: `11308` (民國 113 年 8 月)

### h5 - 健保卡過卡日期時間
- **資料來源**: `patient['hdate'] + patient['htime']`
- **格式**: YYYYMMDDHHMISS (民國年 YYY + 月 MM + 日 DD + 時 HH + 分 MI + 秒 SS)
- **後備**: 使用當前日期時間
- **範例**: `1130804183257`

### h6 - 就醫類別
- **固定值**: `01`
- **說明**: 門診

### h7 - 就醫序號
- **資料來源**: `co03l.dbf` 的 `EDATE` 欄位
- **處理邏輯**:
  1. 以 `{病歷號}_{測量日期}` 為 key 查詢 co03l.dbf
  2. 取得 EDATE 值，去掉前 3 碼民國年
  3. 不足 4 碼時前補 0
- **預設值**: 
  - 查不到資料時使用 `0023` (血壓檢驗項目代碼)
  - 空值時使用 `Z000`

### h8 - 補卡註記
- **固定值**: `1`

### h9 - 身分證字號
- **資料來源**: `patient['pat_id']`
- **必填**: 否
- **說明**: 來自 VISHFAM.DBF 的 PAT_ID 欄位

### h10 - 出生日期
- **資料來源**: `CO01M.DBF` 的 `MBIRTHDT` 欄位
- **查詢方式**: 以病歷號 (KCSTMR) 比對
- **格式**: 民國年格式日期
- **必填**: 否

### h11 - 就醫日期
- **資料來源**: `patient['hdate']`
- **格式**: YYYMMDD (民國年)
- **說明**: 血壓測量日期

### h12 - 就醫日期 (重複)
- **資料來源**: 同 h11
- **說明**: 與 h11 相同

### h15 - 固定標識
- **固定值**: `Y00006`

### h16 - 系統處理時間
- **資料來源**: 匯出時的系統當前時間
- **格式**: YYYMMDDHHMMSS (民國年)
- **說明**: XML 生成時間

### h20 - 檢查時間
- **資料來源**: `patient['hdate'] + patient['htime'][:4]`
- **格式**: YYYYMMDDHHMM (民國年 + 時分)
- **說明**: 血壓檢測的日期時間，只取時分

### h22 - 檢查項目名稱
- **固定值**: `血壓`

### h26 - 狀態標記
- **固定值**: `0`

## 檢驗報告段標籤 (rdata)

每位病患會產生兩個 `<rdata>` 區塊：收縮壓和舒張壓

### 收縮壓 rdata

#### r1 - 報告序號
- **固定值**: `1`

#### r2 - 檢驗項目名稱
- **固定值**: `收縮壓`

#### r3 - 檢驗方法
- **固定值**: `診間血壓監測(OBPM)`

#### r4 - 檢驗報告結果值
- **資料來源**: `patient['systolic']`
- **說明**: GUI 中輸入或載入的收縮壓值

#### r5 - 單位
- **固定值**: `mmHg`

#### r6-1 - 參考值
- **固定值**: `90-130`

#### r9 - 檢驗報告醫事機構代碼
- **資料來源**: 同 h2，來自 GUI 輸入
- **說明**: 與基本資料段的醫事機構代碼相同

#### r10 - 測量時間
- **資料來源**: `patient['htime']` 加一分鐘
- **格式**: YYYMMDDHHMMSS
- **處理邏輯**:
  1. 解析 htime 的時分秒
  2. 分鐘加 1
  3. 處理進位 (60 分 → 0 分 + 1 小時)
  4. 與 hdate 組合

### 舒張壓 rdata

#### r1 - 報告序號
- **固定值**: `2`

#### r2 - 檢驗項目名稱
- **固定值**: `舒張壓`

#### r3 - 檢驗方法
- **固定值**: `診間血壓監測(OBPM)`

#### r4 - 檢驗報告結果值
- **資料來源**: `patient['diastolic']`
- **說明**: GUI 中輸入或載入的舒張壓值

#### r5 - 單位
- **固定值**: `mmHg`

#### r6-1 - 參考值
- **固定值**: `60-80`

#### r9 - 檢驗報告醫事機構代碼
- **資料來源**: 同 h2

#### r10 - 測量時間
- **處理邏輯**: 同收縮壓，加一分鐘

## 資料來源對照

### 主要 DBF 檔案

1. **VISHFAM.DBF** - 病患基本資料
   - `PAT_PID`: 病歷號
   - `PAT_ID`: 身分證字號
   - `PAT_NAMEC`: 姓名

2. **CO18H.DBF** - 檢驗歷史資料
   - `KCSTMR`: 病歷號
   - `HITEM`: 檢驗項目 ('BP')
   - `HVAL`: 血壓值 (格式: "130/80")
   - `HDATE`: 檢驗日期
   - `HTIME`: 檢驗時間

3. **CO01M.DBF** - 病患主檔 (選用)
   - `KCSTMR`: 病歷號
   - `MBIRTHDT`: 出生日期

4. **co03l.dbf** - 就醫記錄 (選用)
   - `KCSTMR`: 病歷號
   - `HDATE`: 就醫日期
   - `EDATE`: 就醫序號

## 檔案格式規範

- **編碼**: Big5
- **換行**: Windows (CRLF)
- **檔案副檔名**: .xml

## 匯出條件

1. **病患篩選**: 必須在 GUI 中勾選
2. **血壓完整性**: 收縮壓和舒張壓都必須大於 0
3. **醫事機構代碼**: 必須已填入

## 特殊處理邏輯

### 民國年轉換
```
西元年 - 1911 = 民國年
例: 2024 - 1911 = 113
```

### 時間處理算法
```python
# 1. 加一分鐘
minute += 1
if minute >= 60:
    minute = 0
    hour += 1
    if hour >= 24:
        hour = 0

# 2. 統一秒數（避免重複上傳失敗）
unified_second = datetime.now().second  # 匯出時當下的秒數
```

**重要說明**: 為避免健保署重複上傳失敗，所有 `<r10>` 標籤的第12、13碼（秒數部分）統一使用資料匯出當下的秒數，而不使用原始測量時間的秒數。

### 日期範圍篩選
- 今年: 當年 1 月 1 日起
- 三個月內: 當日往前推 91 天
- 半年內: 當日往前推 183 天  
- 一年內: 當日往前推 365 天

## 錯誤處理

1. **醫事機構代碼未填**: 禁止選擇資料夾和匯出
2. **DBF 檔案缺失**: CO18H.DBF 必須存在，其他為選用
3. **血壓值不完整**: 自動跳過該病患
4. **欄位缺失**: 使用預設值或跳過該標籤

## 範例輸出

```xml
<?xml version="1.0" encoding="Big5"?>
<patient>
  <hdata>
    <h1>1</h1>
    <h2>3522013684</h2>
    <h3>11</h3>
    <h4>11308</h4>
    <h5>1130804183257</h5>
    <h6>01</h6>
    <h7>0023</h7>
    <h8>1</h8>
    <h9>A123456789</h9>
    <h10>0480319</h10>
    <h11>1130804</h11>
    <h12>1130804</h12>
    <h15>Y00006</h15>
    <h16>1130804193256</h16>
    <h20>11308041834</h20>
    <h22>血壓</h22>
    <h26>0</h26>
    <rdata>
      <r1>1</r1>
      <r2>收縮壓</r2>
      <r3>診間血壓監測(OBPM)</r3>
      <r4>130</r4>
      <r5>mmHg</r5>
      <r6-1>90-130</r6-1>
      <r9>3522013684</r9>
      <r10>11308041835</r10>
    </rdata>
    <rdata>
      <r1>2</r1>
      <r2>舒張壓</r2>
      <r3>診間血壓監測(OBPM)</r3>
      <r4>80</r4>
      <r5>mmHg</r5>
      <r6-1>60-80</r6-1>
      <r9>3522013684</r9>
      <r10>11308041835</r10>
    </rdata>
  </hdata>
</patient>
```