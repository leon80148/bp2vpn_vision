# 特約醫事服務機構每日上傳檢驗(查)結果 XML 格式規定整理

## 一、檔案格式要求

### 1. 檔案命名規則
- **壓縮檔**：`TOTFA.zip`
- **XML 檔**：`TOTFA.xml`
- 主檔名與副檔名只允許英數字
- zip 壓縮檔內容只能含有一個 xml 檔案

### 2. 編碼格式
- XML 編碼：`Big5`
- XML 版本：`1.0`

## 二、XML 結構規範

### 1. 基本結構
```xml
<?xml version="1.0" encoding="Big5"?>
<patient>
  <hdata>
    <!-- 基本資料段 -->
    <h1>...</h1>
    <h2>...</h2>
    ...
    <rdata>
      <!-- 報告資料段 -->
      <r1>...</r1>
      <r2>...</r2>
      ...
    </rdata>
  </hdata>
</patient>
```

### 2. 標籤命名規則
- **基本資料段**：使用 `<hdata>` 包裹，內部欄位使用 `<h循序號>` 格式（h1, h2, h3...）
- **報告資料段**：使用 `<rdata>` 包裹，內部欄位使用 `<r循序號>` 格式（r1, r2, r3...）
- 所有標籤名稱必須使用**小寫英文字母**
- 循序號從 1 開始，由小至大排列

### 3. 重要原則
- 每個欄位的開始標籤與結束標籤必須在同一行
- 不同欄位可用斷行隔開
- 若欄位無資料，建議不出現該標籤（節省空間）
- 標籤必須成對出現，使用巢狀方式排列，不允許交錯重疊

## 三、血壓相關欄位對應

### 基本資料段（hdata）主要欄位：
- `h1`：報告類別（1=檢體檢驗報告）
- `h2`：醫事機構代碼（10 碼）
- `h3`：醫事類別（2 碼）
- `h4`：費用年月（5 碼，如 11408）
- `h5`：健保卡過卡日期時間（申報序號）
- `h6`：案件分類（2 碼）
- `h7`：特定治療項目代號（血壓為 0023）
- `h8`：就醫序號
- `h9`：身分證統一編號
- `h10`：病歷號
- `h11`：就醫日期
- `h12`：治療結束日期
- `h15`：主診斷碼
- `h16`：處方調劑日期時間
- `h17`：醫師身分證號
- `h19`：檢驗日期時間
- `h20`：報告日期時間
- `h22`：病患姓名
- `h26`：轉檢 FLAG

### 報告資料段（rdata）欄位：
- `r1`：報告序號
- `r2`：檢驗項目名稱（如：收縮壓、舒張壓）
- `r3`：檢驗方法（如：生理量測血壓(OBPM)）
- `r4`：檢驗報告結果值
- `r5`：單位（如：mmHg）
- `r6`：參考值（如：收縮壓 90-130，舒張壓 60-80）
- `r6-1`：參考值範圍（替代 r6）
- `r9`：醫事機構代碼
- `r10`：報告時間

## 四、資料格式規定

### 1. 資料型態
- **文數字（X）**：包含 A-z、0-9、空字串、其它符號等
- **數值（9）**：包含 0-9、小數點(.)

### 2. 特殊字元處理
XML 特殊字元必須以**全形**方式上傳：
- `<` → `＜`
- `>` → `＞`
- `&` → `＆`
- `'` → `'`
- `"` → `＂`

### 3. 資料填寫規則
- 有資料時：
  - 文數字無需左靠，位數不足不用補空白
  - 數字無需右靠，位數不足不用補零
- 無資料時：不需要出現該標籤

## 五、血壓資料上傳範例

```xml
<?xml version="1.0" encoding="Big5"?>
<patient>
  <hdata>
    <h1>1</h1>
    <h2>3522013684</h2>
    <h3>11</h3>
    <h4>11408</h4>
    <h5>1140804183257</h5>
    <h6>01</h6>
    <h7>0023</h7>
    <h8>1</h8>
    <h9>Q120277903</h9>
    <h10>0480319</h10>
    <h11>1140804</h11>
    <h12>1140804</h12>
    <h15>Y00006</h15>
    <h16>1140804193256</h16>
    <h17>N125074991</h17>
    <h19>11408041834</h19>
    <h20>11408041834</h20>
    <h22>病患姓名</h22>
    <h26>0</h26>
    <rdata>
      <r1>1</r1>
      <r2>收縮壓</r2>
      <r3>生理量測血壓(OBPM)</r3>
      <r4>102</r4>
      <r5>mmHg</r5>
      <r6-1>90-130</r6-1>
      <r9>3522013684</r9>
      <r10>11408041835</r10>
    </rdata>
    <rdata>
      <r1>2</r1>
      <r2>舒張壓</r2>
      <r3>生理量測血壓(OBPM)</r3>
      <r4>54</r4>
      <r5>mmHg</r5>
      <r6-1>60-80</r6-1>
      <r9>3522013684</r9>
      <r10>11408041835</r10>
    </rdata>
  </hdata>
</patient>
```

## 六、檢核要點

1. **XML 良好格式檢查**：
   - 共同宣告必須在第一行
   - `<patient>` 標籤必須成對
   - 所有標籤必須成對且巢狀排列

2. **XSD 驗證檢核**：
   - 標籤名稱必須符合規定且使用小寫
   - 標籤順序須依編號由小至大排列
   - 資料長度必須符合規定

3. **退件原因**：
   - 壓縮檔非 zip 格式
   - 檔案命名不符規範
   - XML 格式錯誤
   - 標籤順序錯誤
   - 資料長度超過限制